# iptables-restore format file generated by Ansible template
# This file creates DNAT rules for traffic coming in on the wireguard interface
# and ensures the forwarded packets are accepted in the filter table.
# We match TCP dports defined in ports and DNAT them to target_ip.
# We also add a POSTROUTING MASQUERADE for traffic from the Tailscale range to the target,
# which helps with return routing when the target is reached via a different interface.
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
{% for port in ports %}
-A PREROUTING -i {{ wireguard_iface }} -p tcp --dport {{ port }} -j DNAT --to-destination {{ target_ip }}:{{ port }}
-A POSTROUTING -o eth0 -d {{ target_ip }} -p tcp --dport {{ port }} -j MASQUERADE
{% endfor %}
# Masquerade traffic originated from Tailscale network to the target IP so replies are routed back
COMMIT

*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
# Allow established and related traffic so replies are accepted
-A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
# Allow forwarded TCP traffic coming in on wireguard interface to the target IP and ports
{% for port in ports %}
-A FORWARD -i {{ wireguard_iface }} -o eth0 -p tcp --dport {{ port }} -d {{ target_ip }} -j ACCEPT
-A FORWARD -i eth0 -o {{ wireguard_iface }} -p tcp --sport {{ port }} -s {{ target_ip }} -j ACCEPT
{% endfor %}
COMMIT
