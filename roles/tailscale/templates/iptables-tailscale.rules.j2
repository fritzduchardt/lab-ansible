# iptables-restore format file generated by Ansible template
# This file creates DNAT rules for traffic coming in on the tailscale interface
# and ensures the forwarded packets are accepted in the filter table.
# We match TCP dports defined in ports and DNAT them to target_ip.
# We also add a POSTROUTING MASQUERADE for traffic from the Tailscale range to the target,
# which helps with return routing when the target is reached via a different interface.
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
{% for port in ports %}
-A PREROUTING -i {{ tailscale_iface }} -p tcp --dport {{ port }} -j DNAT --to-destination {{ target_ip }}:{{ port }}
{% endfor %}
# Masquerade traffic originated from Tailscale network to the target IP so replies are routed back
-A POSTROUTING -s 100.64.0.0/10 -d {{ target_ip }} -j MASQUERADE
COMMIT

*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]100.93.106.112
:OUTPUT ACCEPT [0:0]
# Allow established and related traffic
-A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
# Allow forwarded TCP traffic directed to the target IP and ports
{% for port in ports %}
-A FORWARD -p tcp -d {{ target_ip }} --dport {{ port }} -j ACCEPT
{% endfor %}
COMMIT
